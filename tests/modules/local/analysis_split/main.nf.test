nextflow_process{
    name "Test module ANALYSIS_SPLIT"
    script "modules/local/analysis_split/main.nf"
    process "ANALYSIS_SPLIT"
    
    tag "modules"
    tag "modules_local"
    tag "modules/analysis_split"

    test("analysis split happy path - success") {

        when {
            process {
                """
                params.clinical_url = "https://submission.pcgl-dev.cumulus.genomeinformatics.org"
                params.file_manager_url = "https://file-manager.pcgl-dev.cumulus.genomeinformatics.org"
                // Test input with molecular metadata files (all TSV format)
                input[0] = ["EXAMPLE-CA"]
                input[1] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Files.tsv')]
                input[2] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Analysis.tsv')]
                input[3] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Workflow.tsv')]
                input[4] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Read_Group.tsv')]
                input[5] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Experiment.tsv')]
                input[6] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Specimen.tsv')]
                input[7] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Sample.tsv')]
                input[8] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/relational_mapping.json')]
                """
            }
        }

        then {
            assertAll(
                { assert process.out.status},
                { assert process.out.versions}
            )
        }
    }

    test("analysis split no biospecimens - success") {

        when {
            process {
                """
                params.clinical_url = "https://submission.pcgl-dev.cumulus.genomeinformatics.org"
                params.file_manager_url = "https://file-manager.pcgl-dev.cumulus.genomeinformatics.org"
                // Test input with molecular metadata files (all TSV format)
                input[0] = ["EXAMPLE-CA"]
                input[1] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Files.tsv')]
                input[2] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Analysis.tsv')]
                input[3] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Workflow.tsv')]
                input[4] = [[]]
                input[5] = [[]]
                input[6] = [[]]
                input[7] = [[]]
                input[8] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/relational_mapping.json')]
                """
            }
        }

        then {
            assertAll(
                { assert process.out.status},
                { assert process.out.versions}
            )
        }
    }

    test("analysis split bad path - fail") {

        when {
            process {
                """
                params.clinical_url = "https://submission.pcgl-dev.cumulus.genomeinformatics.org"
                params.file_manager_url = "https://file-manager.pcgl-dev.cumulus.genomeinformatics.org"
                // Test input with molecular metadata files (all TSV format)
                input[0] = ["EXAMPLE-CA"]
                input[1] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/bad_path/Files.tsv')]
                input[2] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/bad_path/Duplicate_Analysis.tsv')]
                input[3] = [[]]
                input[4] = [[]]
                input[5] = [[]]
                input[6] = [[]]
                input[7] = [[]]
                input[8] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/relational_mapping.json')]
                """
            }
        }

        then {
            assertAll(
                { assert process.out.status},
                { assert process.out.versions}
            )
        }
    }

    test("analysis split stub") {
        options "-stub-run"
        when {
            process {
                """
                params.clinical_url = "https://submission.pcgl-dev.cumulus.genomeinformatics.org"
                params.file_manager_url = "https://file-manager.pcgl-dev.cumulus.genomeinformatics.org"
                // Test input with molecular metadata files (all TSV format)
                input[0] = ["EXAMPLE-CA"]
                input[1] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Files.tsv')]
                input[2] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Analysis.tsv')]
                input[3] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/Workflow.tsv')]
                input[4] = [[]]
                input[5] = [[]]
                input[6] = [[]]
                input[7] = [[]]
                input[8] = [file('${projectDir}/tests/modules/local/check_dependencies/test_data/happy_path/relational_mapping.json')]
                """
            }
        }

        then {
            assertAll(
                { assert process.out.status},
                { assert process.out.versions}
            )
        }
    }
}